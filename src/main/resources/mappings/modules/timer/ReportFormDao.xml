<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zz.HttpClient.modules.timer.dao.ReportFormDao">
	
	<!-- 催收报表 -->
	<select id="getOdReportForm" resultType="CustomerReportForm">
		SELECT
			DISTINCT
			CI.[TASK_ID],
			CI.[CONTRACT_NUM],
			CI.[OD_NAME],
			CI.[RTYPE],
			CI.[PHONE_NUM],
			CI.[OD_DAYS],
			CI.[OD_AMOUNT],
			CI.[ADDRESS_TYPE],
			CI.[REQUEST_EMPNO],
			CI.[REQUEST_DATETIME],
			CI.[REMARK],
			CI.[SEND_BATCH],
			CI.[CALL_RESULT],
			CASE 
			WHEN CU.[EXTERNAL_CONTRACT_NBR] IS NULL THEN '已还款'
			ELSE '未还款' END
			AS [REPAYMENT] 
			FROM 
		((SELECT DISTINCT
			CI.[TASK_ID],
			CI.[CONTRACT_NUM],
			CI.[OD_NAME],
			CI.[RTYPE],
			CI.[PHONE_NUM],
			CI.[OD_DAYS],
			CI.[OD_AMOUNT],
			CI.[ADDRESS_TYPE],
			CI.[REQUEST_EMPNO],
			CI.[REQUEST_DATETIME],
			CI.[REMARK],
			CI.[SEND_BATCH],
			CASE 
			WHEN 1 = 1 THEN '通话失败'
			ELSE '通话失败' END AS [CALL_RESULT]
		FROM [Message].[dbo].[COLLECTION_INFO] CI
		LEFT JOIN (SELECT CII.[TASK_ID],[CONTRACT_NUM],[PHONE_NUM],[SEND_BATCH]
				FROM [Message].[dbo].[COLLECTION_INFO] CII
				LEFT JOIN [Message].[dbo].[COLLECTION_RESULT] CRR ON CII.TASK_ID = CRR.TASK_ID AND CII.PHONE_NUM = CRR.TELL_NUMBER
				WHERE DATEDIFF(dd, [REQUEST_DATETIME], GETDATE()) = 1 AND CII.SEND_BATCH = #{sendBatch} AND CRR.RESULT <![CDATA[<> ]]> 3) CS ON CI.TASK_ID = CS.TASK_ID AND CI.PHONE_NUM = CS.[PHONE_NUM]
		LEFT JOIN [Message].[dbo].[COLLECTION_RESULT] CR ON CI.TASK_ID = CR.TASK_ID AND CI.PHONE_NUM = CR.TELL_NUMBER
		LEFT JOIN [Message].[dbo].[COLLECTION_RESULT_CODE] CO ON CR.[RESULT] = CO.[RESULT_CODE]
		WHERE DATEDIFF(dd, CI.[REQUEST_DATETIME], GETDATE()) = 1 AND CI.SEND_BATCH = #{sendBatch} AND CS.CONTRACT_NUM IS NULL)
			UNION
		(SELECT DISTINCT
			CI.[TASK_ID],
			CI.[CONTRACT_NUM],
			CI.[OD_NAME],
			CI.[RTYPE],
			CI.[PHONE_NUM],
			CI.[OD_DAYS],
			CI.[OD_AMOUNT],
			CI.[ADDRESS_TYPE],
			CI.[REQUEST_EMPNO],
			CI.[REQUEST_DATETIME],
			CI.[REMARK],
			CI.[SEND_BATCH],
			CO.[CODE_NAME] AS [CALL_RESULT]
		FROM [Message].[dbo].[COLLECTION_INFO] CI
		LEFT JOIN [Message].[dbo].[COLLECTION_RESULT] CR ON CI.TASK_ID = CR.TASK_ID AND CI.PHONE_NUM = CR.TELL_NUMBER
		LEFT JOIN [Message].[dbo].[COLLECTION_RESULT_CODE] CO ON CR.[RESULT] = CO.[RESULT_CODE]
		WHERE DATEDIFF(dd, [REQUEST_DATETIME], GETDATE()) = 1 AND CI.SEND_BATCH = #{sendBatch} AND CR.RESULT <![CDATA[<> ]]> 3)) AS CI
		LEFT JOIN (
			SELECT * FROM OPENQUERY(YFC_PROD,'
			SELECT * from (
			SELECT 
				C.EXTERNAL_CONTRACT_NBR, 
				AD.FIRST_THI_NME OD_NAME,
				PHO.RTYPE,
				PHO.PHONE_NUMBER,
				MAX(CASE WHEN P.CMP_RECEIVABLE_AMT = 0 THEN 0 ELSE P.OD_DAYS END) OD_DAYS,
				SUM(P.CMP_RECEIVABLE_AMT) + SUM(NVL(O.NET_OVERDUE_AMT,0)) OD_AMOUNT,
				PHO.ADDRESS_TYPE
					FROM YFC_RETAIL_PROD.REPAYMENT_PLAN P 
					INNER JOIN CONTRACT C ON C.CONTRACT_ID = P.CONTRACT_ID AND C.LIVE_STS = ''L''
					LEFT JOIN YFC_RETAIL_PROD.RENTAL_OVERDUE O ON O.CONTRACT_ID = P.CONTRACT_ID AND O.RENTAL_ID = P.RENTAL_ID AND P.AGREEMENT_SEQ = P.AGREEMENT_SEQ
					LEFT JOIN APPLICANT_DETAIL AD ON AD.APPLICATION_NUMBER = C.PROPOSAL_NBR AND AD.IDENTIFICATION_CODE = 1
					LEFT JOIN COMPANY_DETAIL CD ON CD.APPLICATION_NUMBER = C.PROPOSAL_NBR AND CD.IDENTIFICATION_CODE = 1
					LEFT JOIN 
					(	SELECT EXTERNAL_CONTRACT_NBR,RTYPE,PHONE_NUMBER,ADDRESS_TYPE FROM (
						SELECT DISTINCT C.EXTERNAL_CONTRACT_NBR,
							CASE WHEN AT.APPLICANT_TYPE = ''I'' THEN AT.NAME
									WHEN AT.APPLICANT_TYPE = ''C'' THEN (SELECT isnull (comdet.company_thi_nme)
																		FROM company_detail comdet 
																		WHERE  C.PROPOSAL_NBR = comdet.application_number AND comdet.identification_code = AT.identification_code) 
									ELSE AT.NAME END BNAME,
							CASE WHEN AT.MAIN_APPLICANT = ''Y'' THEN ''借款人'' 
									WHEN AT.MAIN_APPLICANT IS NULL AND AT.GUARANTOR_TYPE IS NULL THEN ''共同借款人'' 
									WHEN AT.GUARANTOR_TYPE = ''I'' THEN ''担保人'' 
									END RTYPE,
							PTC.PHONE_TYPE_DSC,BP.PHONE_NBR PHONE_NUMBER,
							CASE WHEN ADS.DEFAULT_ADDRESS = ''Y'' AND ADS.HUKOU_ADDRESS = ''Y'' THEN ''户籍邮寄地''
									WHEN ADS.DEFAULT_ADDRESS = ''N'' AND ADS.HUKOU_ADDRESS = ''N'' THEN ''现居地''
									WHEN ADS.DEFAULT_ADDRESS = ''Y'' AND ADS.HUKOU_ADDRESS = ''N'' THEN ''邮寄地''
									WHEN ADS.DEFAULT_ADDRESS = ''N'' AND ADS.HUKOU_ADDRESS = ''Y'' THEN ''户籍地''
									END ADDRESS_TYPE,
							SC.STATE_NME||CC.CITY_NME||ADS.UNIT_NO ADDRESS_STR,
							'''' COMPANY_NAME,
							CASE WHEN BI.GENDER_STS = ''M'' THEN ''男''
									WHEN BI.GENDER_STS = ''F'' THEN ''女'' ELSE BI.GENDER_STS
									END GENDER_STS
							FROM CONTRACT C
									LEFT JOIN APPLICANT_TYPE AT ON C.PROPOSAL_NBR = AT.APPLICATION_NUMBER AND AT.MAIN_APPLICANT = ''Y''
									LEFT JOIN BP_INDIVIDUAL BI ON AT.BUSINESS_PARTNER_ID = BI.BUSINESS_PARTNER_ID
									LEFT JOIN BP_PHONE BP ON AT.BUSINESS_PARTNER_ID = BP.BUSINESS_PARTNER_ID
									LEFT JOIN PHONE_TYPE_CODE PTC ON PTC.PHONE_TYPE_CDE = BP.PHONE_TYPE_CDE
									LEFT JOIN ADDRESS ADS ON AT.APPLICATION_NUMBER = ADS.APPLICATION_NUMBER AND ADS.IDENTIFICATION_CODE = AT.IDENTIFICATION_CODE
									LEFT JOIN CITY_CODE CC ON CC.CITY_CDE = ADS.CITY_CDE
									LEFT JOIN STATE_CODE SC ON SC.STATE_CDE = ADS.STATE_CDE
									WHERE AT.IS_INACTIVE_IND <![CDATA[<> ]]> ''T'' OR AT.IS_INACTIVE_IND IS NULL
									UNION 
									SELECT DISTINCT
									C.EXTERNAL_CONTRACT_NBR,
									CASE WHEN ATE.APPLICANT_TYPE = ''I'' THEN ATE.NAME
											WHEN ATE.APPLICANT_TYPE = ''C'' THEN (SELECT isnull (comdet.company_thi_nme) FROM company_detail comdet 
																															WHERE  C.PROPOSAL_NBR = comdet.application_number AND comdet.identification_code = ATE.identification_code) 
											ELSE ATE.NAME END BNAME,
									CASE WHEN ATE.MAIN_APPLICANT = ''Y'' THEN ''借款人'' 
											WHEN ATE.MAIN_APPLICANT IS NULL AND ATE.GUARANTOR_TYPE IS NULL THEN ''共同借款人'' 
											WHEN ATE.GUARANTOR_TYPE = ''I'' THEN ''担保人'' 
											END RTYPE,
									''工作地电话'' PHONE_TYPE_DSC, 
									ISNULL(EMR.PHONE,''无'') PHONE_NUMBER,
									''工作地址'' ADDRESS_TYPE,
									SC.state_nme||cc.city_nme||ISNULL(EMR.ADDRESS_ONE_2,'''') ADDRESS_STR,
									ISNULL(EMR.NAME_2,''无'') COMPANY_NAME,
									CASE WHEN BI.GENDER_STS = ''M'' THEN ''男''
											WHEN BI.GENDER_STS = ''F'' THEN ''女'' ELSE BI.GENDER_STS
											END GENDER_STS
									FROM CONTRACT C 
									LEFT JOIN APPLICANT_TYPE ATE ON C.PROPOSAL_NBR = ATE.APPLICATION_NUMBER AND ATE.MAIN_APPLICANT = ''Y''
									LEFT JOIN BP_INDIVIDUAL BI ON ATE.BUSINESS_PARTNER_ID = BI.BUSINESS_PARTNER_ID
									LEFT JOIN EMPLOYER EMR ON C.PROPOSAL_NBR = EMR.APPLICATION_NUMBER AND EMR.IDENTIFICATION_CODE = ATE.IDENTIFICATION_CODE
									LEFT JOIN city_code CC ON CC.city_cde = emr.city_cde
									LEFT JOIN state_code SC ON SC.state_cde = emr.state_cde
					) WHERE PHONE_TYPE_DSC = ''手机'' AND RTYPE = ''借款人'') PHO ON C.EXTERNAL_CONTRACT_NBR = PHO.EXTERNAL_CONTRACT_NBR
					WHERE P.AGREEMENT_SEQ = 1 and sysdate >= DUE_DTE AND (P.SETTLE_AMT is null OR P.SETTLE_AMT &lt; P.RENTAL_AMT OR O.NET_OVERDUE_AMT &gt; 0)
					GROUP BY P.CONTRACT_ID,C.EXTERNAL_CONTRACT_NBR ,AD.FIRST_THI_NME,PHO.PHONE_NUMBER,PHO.RTYPE,PHO.ADDRESS_TYPE,CD.COMPANY_THI_NME					 
			) A WHERE PHONE_NUMBER IS NOT NULL AND PHONE_NUMBER <![CDATA[<> ]]> ''0'' AND OD_NAME IS NOT NULL AND A.OD_DAYS BETWEEN ''1'' AND ''20''
		')) CU ON CI.[CONTRACT_NUM] = CU.[EXTERNAL_CONTRACT_NBR]
	</select>
</mapper>  