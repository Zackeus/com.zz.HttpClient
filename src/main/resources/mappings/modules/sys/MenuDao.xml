<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zz.HttpClient.Dao.sys.MenuDao">
	
	<sql id="menuColumns">
		M.[ID],
		M.[PARENT_ID],
      	M.[TITLE],
      	M.[ICON],
      	M.[SORT],
      	M.[HREF],
      	M.[SPREAD],
      	M.[CREATE_DATE],
      	M.[UPDATE_TIME],
      	M.[CREATE_BY],
      	M.[UPDATE_BY],
      	M.[SYS_ID],
      	M.[REMARKS]
	</sql>
	
	<resultMap type="Menu" id="menuResultMap">
		<id property="id" column="ID" />
		<result property="parentId" column="PARENT_ID" />
		<result property="userId" column="USER_ID" />
		<collection property="children" column="{parentId = ID, userId = USER_ID}" select="getMenuList"/>
	</resultMap>
	
	<resultMap type="Menu" id="allMenuResultMap">
		<id property="id" column="ID" />
		<result property="parentId" column="PARENT_ID" />
		<collection property="children" column="ID" select="findAllList"/>
	</resultMap>
	
	<select id="getAllTreeMenus" resultType="Menu">
		SELECT DISTINCT
		<include refid="menuColumns"/>
		FROM [Message].[dbo].[SYS_MENU] M
		WHERE M.[PARENT_ID] = '1'
		ORDER BY M.[SORT]
	</select>
	
	<select id="getTreeMenus" resultType="Menu">
		SELECT DISTINCT
		<include refid="menuColumns"/>,
		U.id AS [USER_ID]
		FROM [Message].[dbo].[SYS_MENU] M
		JOIN [Message].[dbo].[SYS_ROLE_MENU] RM ON RM.[MENU_ID] = M.[ID]
		JOIN [Message].[dbo].[SYS_ROLE] R ON R.[ID] = RM.[ROLE_ID]
		JOIN [Message].[dbo].[SYS_USER_ROLE] UR ON UR.[ROLE_ID] = r.[ID]
		JOIN [10.5.60.80].[jeesite-yfc].[dbo].[sys_user] U ON U.id = UR.[USER_ID] AND u.id = #{userId}
		WHERE M.[PARENT_ID] = '1'
		ORDER BY M.[SORT]
	</select>
	
	<select id="findAllList" resultMap="allMenuResultMap">
		SELECT
		<include refid="menuColumns"/>
		FROM [Message].[dbo].[SYS_MENU] M
		WHERE M.[PARENT_ID] = #{parentId}
		ORDER BY [SORT]
	</select>
	
	<select id="getMenuList" resultMap="menuResultMap">
		SELECT DISTINCT
		<include refid="menuColumns"/>,
		U.id AS [USER_ID]
		FROM [Message].[dbo].[SYS_MENU] M
		JOIN [Message].[dbo].[SYS_ROLE_MENU] RM ON RM.[MENU_ID] = M.[ID]
		JOIN [Message].[dbo].[SYS_ROLE] R ON R.[ID] = RM.[ROLE_ID]
		JOIN [Message].[dbo].[SYS_USER_ROLE] UR ON UR.[ROLE_ID] = r.[ID]
		JOIN [10.5.60.80].[jeesite-yfc].[dbo].[sys_user] U ON U.id = UR.[USER_ID] AND u.id = #{userId}
		WHERE M.[PARENT_ID] = #{parentId}
		ORDER BY [SORT]
	</select>
	
</mapper>